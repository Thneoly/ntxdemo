# 负载测试架构图解

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Scheduler (调度器)                            │
│                                                                       │
│  ┌─────────────────┐   ┌──────────────────┐   ┌─────────────────┐  │
│  │  Scenario       │   │  IpPoolManager   │   │  UserManager    │  │
│  │  Parser         │──▶│  - pools: Map    │──▶│  - users: Vec   │  │
│  │  (YAML → DSL)   │   │  - allocate()    │   │  - spawn()      │  │
│  │                 │   │  - release()     │   │  - schedule()   │  │
│  └─────────────────┘   └──────────────────┘   └─────────────────┘  │
│                                                          │            │
│                                                          ▼            │
└──────────────────────────────────────────────────────────┼───────────┘
                                                           │
                          ┌────────────────────────────────┤
                          │                                │
                          ▼                                ▼
              ┌───────────────────────┐        ┌───────────────────────┐
              │   User Instance 1     │        │   User Instance N     │
              │                       │        │                       │
              │ ┌───────────────────┐ │        │ ┌───────────────────┐ │
              │ │  UserContext      │ │        │ │  UserContext      │ │
              │ │  - id: 1          │ │        │ │  - id: N          │ │
              │ │  - tenant: "A"    │ │        │ │  - tenant: "B"    │ │
              │ │  - ip: 10.0.1.0   │ │        │ │  - ip: 10.0.2.0   │ │
              │ └───────────────────┘ │        │ └───────────────────┘ │
              │                       │        │                       │
              │ ┌───────────────────┐ │        │ ┌───────────────────┐ │
              │ │  UserExecutor     │ │        │ │  UserExecutor     │ │
              │ │  - workflow       │ │        │ │  - workflow       │ │
              │ │  - iterations: 3  │ │        │ │  - iterations: 5  │ │
              │ │  - think_time: 1s │ │        │ │  - think_time: 2s │ │
              │ └───────────────────┘ │        │ └───────────────────┘ │
              │          │            │        │          │            │
              └──────────┼────────────┘        └──────────┼────────────┘
                         │                                │
                         │      ┌─────────────────────────┘
                         │      │
                         ▼      ▼
              ┌────────────────────────────────┐
              │      Executor (执行器)          │
              │                                │
              │  ┌──────────────────────────┐  │
              │  │  ActionComponent         │  │
              │  │  - init()                │  │
              │  │  - do_action()           │  │
              │  │  - release()             │  │
              │  └──────────────────────────┘  │
              │              │                  │
              └──────────────┼──────────────────┘
                             │
                             ▼
              ┌────────────────────────────────┐
              │   Actions-HTTP (HTTP 组件)      │
              │                                │
              │  ┌──────────────────────────┐  │
              │  │  HTTP Request Handler    │  │
              │  │  - parse URL             │  │
              │  │  - resolve {{variables}} │  │
              │  │  - bind source IP        │  │
              │  │  - send request          │  │
              │  │  - parse response        │  │
              │  └──────────────────────────┘  │
              │              │                  │
              └──────────────┼──────────────────┘
                             │
                             ▼
              ┌────────────────────────────────┐
              │    Core-Libs (核心库)           │
              │                                │
              │  ┌────────────┐  ┌──────────┐  │
              │  │  IpPool    │  │  Socket  │  │
              │  │  - ranges  │  │  - fd    │  │
              │  │  - allocate│  │  - bind  │  │
              │  │  - release │  │  - connect│  │
              │  └────────────┘  └──────────┘  │
              └────────────────────────────────┘
                             │
                             ▼
              ┌────────────────────────────────┐
              │    WASI Runtime / OS           │
              │    (TCP/IP Stack)              │
              └────────────────────────────────┘
```

## 数据流

### 1. 初始化流程

```
┌──────────┐   1. Load YAML    ┌──────────┐
│   YAML   │──────────────────▶│ Scenario │
│  Config  │                   │  Parser  │
└──────────┘                   └────┬─────┘
                                    │
                                    │ 2. Parse
                                    ▼
                     ┌──────────────────────────┐
                     │  Scenario DSL Object     │
                     │  - workbook.ip_pools     │
                     │  - load.ramp_up          │
                     │  - actions               │
                     │  - workflows             │
                     └─────────┬────────────────┘
                               │
                 ┌─────────────┼─────────────┐
                 │             │             │
                 ▼             ▼             ▼
         ┌──────────┐  ┌──────────┐  ┌──────────┐
         │ IP Pools │  │ Actions  │  │Workflows │
         │  Setup   │  │  Setup   │  │  Setup   │
         └──────────┘  └──────────┘  └──────────┘
```

### 2. 用户生成流程

```
Time: t=0s                t=1s                 t=2s                t=5s
      │                   │                    │                   │
      │  Scheduler Wait   │   Spawn Phase 1    │  Spawn Phase 2   │  Spawn Phase 3
      │                   │                    │                   │
      ▼                   ▼                    ▼                   ▼
  ┌───────┐         ┌────────────┐       ┌────────────┐      ┌────────────┐
  │ IDLE  │────────▶│ Generate   │──────▶│ Generate   │─────▶│ Generate   │
  │       │         │ 100 Users  │       │ 30 Users   │      │ 50 Users   │
  └───────┘         └────┬───────┘       └────┬───────┘      └────┬───────┘
                         │                     │                    │
                         │ Allocate IPs        │ Allocate IPs       │ Allocate IPs
                         ▼                     ▼                    ▼
                   ┌──────────┐          ┌──────────┐         ┌──────────┐
                   │ 10.0.1.0 │          │10.0.1.100│         │10.0.1.130│
                   │    to    │          │    to    │         │    to    │
                   │10.0.1.99 │          │10.0.1.129│         │10.0.1.179│
                   └────┬─────┘          └────┬─────┘         └────┬─────┘
                        │                     │                     │
                        └──────────┬──────────┴─────────────────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Users Start     │
                          │ Executing       │
                          │ Workflows       │
                          └─────────────────┘
```

### 3. 用户执行流程

```
User Timeline (mode: loop, iterations: 3)

t=0s    │ spawn
        │
        ▼
t=0s    ┌─────────────────────────────────────┐
        │  Iteration 1                        │
        │  ┌──────────┐    ┌──────────┐       │
        │  │ Action 1 │───▶│ Action 2 │       │
        │  │(bind IP) │    │(bind IP) │       │
        │  └──────────┘    └──────────┘       │
        └─────────────────────────────────────┘
        │
t=1s    │ think_time (1s)
        │
        ▼
t=1s    ┌─────────────────────────────────────┐
        │  Iteration 2                        │
        │  ┌──────────┐    ┌──────────┐       │
        │  │ Action 1 │───▶│ Action 2 │       │
        │  │(bind IP) │    │(bind IP) │       │
        │  └──────────┘    └──────────┘       │
        └─────────────────────────────────────┘
        │
t=2s    │ think_time (1s)
        │
        ▼
t=2s    ┌─────────────────────────────────────┐
        │  Iteration 3                        │
        │  ┌──────────┐    ┌──────────┐       │
        │  │ Action 1 │───▶│ Action 2 │       │
        │  │(bind IP) │    │(bind IP) │       │
        │  └──────────┘    └──────────┘       │
        └─────────────────────────────────────┘
        │
t=3s    │ exit
        │ release IP
        ▼
```

### 4. Action 执行流程 (带 IP 绑定)

```
┌──────────────────────────────────────────────────────────────┐
│  do_http_action(action: ActionDef)                           │
└────┬─────────────────────────────────────────────────────────┘
     │
     ▼
┌──────────────────────────────────────────────────────────┐
│ 1. Extract Parameters                                    │
│    - url: "http://192.168.1.100:8080/api"               │
│    - bind_ip: "10.0.1.5" (from {{user.allocated_ip}})   │
│    - headers, body, etc.                                 │
└────┬─────────────────────────────────────────────────────┘
     │
     ▼
┌──────────────────────────────────────────────────────────┐
│ 2. Create Socket                                         │
│    socket = Socket::tcp_v4()                             │
└────┬─────────────────────────────────────────────────────┘
     │
     ▼
┌──────────────────────────────────────────────────────────┐
│ 3. Bind Source IP (if specified)                         │
│    if bind_ip.is_some():                                 │
│      socket.bind_to_ip(10.0.1.5, 0)  ← Port 0 = auto    │
│                                                          │
│    OS assigns: 10.0.1.5:54321 (ephemeral port)          │
└────┬─────────────────────────────────────────────────────┘
     │
     ▼
┌──────────────────────────────────────────────────────────┐
│ 4. Connect to Destination                                │
│    socket.connect(192.168.1.100:8080)                    │
│                                                          │
│    TCP Connection:                                       │
│      Source: 10.0.1.5:54321                             │
│      Dest:   192.168.1.100:8080                         │
└────┬─────────────────────────────────────────────────────┘
     │
     ▼
┌──────────────────────────────────────────────────────────┐
│ 5. Send HTTP Request                                     │
│    request = HttpRequest::new("GET", url)                │
│              .headers(headers)                           │
│              .build()                                    │
│                                                          │
│    socket.send(request.to_bytes())                       │
└────┬─────────────────────────────────────────────────────┘
     │
     ▼
┌──────────────────────────────────────────────────────────┐
│ 6. Receive HTTP Response                                 │
│    buf = socket.recv(8192)                               │
│    response = HttpResponse::parse(buf)                   │
└────┬─────────────────────────────────────────────────────┘
     │
     ▼
┌──────────────────────────────────────────────────────────┐
│ 7. Return Result                                         │
│    "GET /api status=200 body_len=1234 from_ip=10.0.1.5" │
└──────────────────────────────────────────────────────────┘
```

## IP 池状态变化

```
初始状态:
┌────────────────────────────────┐
│  IP Pool: eip-pool-1           │
│  Ranges: 10.0.1.0/24           │
│          10.0.2.0/24           │
│  Total: 508 IPs                │
│  Available: 508                │
│  Allocated: 0                  │
└────────────────────────────────┘

t=1s: Spawn 100 users
┌────────────────────────────────┐
│  IP Pool: eip-pool-1           │
│  Available: 408                │
│  Allocated: 100                │
│  ┌──────────────────────────┐  │
│  │ 10.0.1.0  → User-001     │  │
│  │ 10.0.1.1  → User-002     │  │
│  │ ...                      │  │
│  │ 10.0.1.99 → User-100     │  │
│  └──────────────────────────┘  │
└────────────────────────────────┘

t=2s: Spawn 30 more users
┌────────────────────────────────┐
│  IP Pool: eip-pool-1           │
│  Available: 378                │
│  Allocated: 130                │
│  ┌──────────────────────────┐  │
│  │ 10.0.1.100 → User-101    │  │
│  │ 10.0.1.101 → User-102    │  │
│  │ ...                      │  │
│  │ 10.0.1.129 → User-130    │  │
│  └──────────────────────────┘  │
└────────────────────────────────┘

t=10s: All users exit (release_on: user_exit)
┌────────────────────────────────┐
│  IP Pool: eip-pool-1           │
│  Available: 508                │
│  Allocated: 0                  │
│  (All IPs returned to pool)    │
└────────────────────────────────┘
```

## 多租户场景

```
┌──────────────────────────────────────────────────────────────────┐
│                      IP Pool Configuration                        │
│                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ tenant-a-pool   │  │ tenant-b-pool   │  │ shared-pool     │  │
│  │ 10.0.1.0/24     │  │ 10.0.2.0/24     │  │ 10.0.3.0/24     │  │
│  │ (254 IPs)       │  │ (254 IPs)       │  │ 10.0.4.0/24     │  │
│  │                 │  │                 │  │ (508 IPs)       │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
└───────────┼────────────────────┼────────────────────┼───────────┘
            │                    │                    │
            │                    │                    │
     ┌──────▼──────┐      ┌──────▼──────┐     ┌──────▼──────┐
     │  Tenant A   │      │  Tenant B   │     │  Internal   │
     │  350 Users  │      │  130 Users  │     │  20 Users   │
     │             │      │             │     │             │
     │ Phase 1: 50 │      │ Phase 3: 30 │     │ Phase 4: 20 │
     │ Phase 2:100 │      │ Phase 5:100 │     │             │
     │ Phase 4:200 │      │             │     │             │
     └─────────────┘      └─────────────┘     └─────────────┘
            │                    │                    │
            │                    │                    │
            └────────┬───────────┴────────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │  Target API Server    │
         │  192.168.1.100:8080   │
         └───────────────────────┘

租户隔离效果:
- Tenant A 流量来源: 10.0.1.x (最多 254 个不同 IP)
- Tenant B 流量来源: 10.0.2.x (最多 254 个不同 IP)
- Internal 流量来源: 10.0.3.x, 10.0.4.x (最多 508 个不同 IP)
```

## 监控数据流

```
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│  Scheduler   │──────▶│  Prometheus  │──────▶│   Grafana    │
│              │       │   Exporter   │       │   Dashboard  │
│ ┌──────────┐ │       │              │       │              │
│ │ Metrics  │ │       │ Scrape /     │       │ Visualize    │
│ │ Collector│ │       │ metrics      │       │              │
│ └──────────┘ │       │              │       │              │
└──────────────┘       └──────────────┘       └──────────────┘

Metrics:
  scheduler_users_spawned_total
  scheduler_users_active
  scheduler_ip_pool_available
  executor_tasks_executed_total
  http_requests_duration_seconds
```

---

**用途**: 帮助理解系统各组件如何协同工作
**更新**: 2024-11-30
